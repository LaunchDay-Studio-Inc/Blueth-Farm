name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GODOT_VERSION: "4.3"
  EXPORT_NAME: blueth-farm

jobs:
  lint:
    name: GDScript Linting
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install gdtoolkit
        run: |
          pip install gdtoolkit==4.*

      - name: Run gdlint
        working-directory: game
        run: |
          echo "Running gdlint on all GDScript files..."
          gdlint scripts/**/*.gd || true
          echo "Linting complete (non-blocking for now)"

      - name: Check gdformat
        working-directory: game
        run: |
          echo "Checking code formatting..."
          gdformat --check scripts/**/*.gd || true
          echo "Format check complete (non-blocking for now)"

  validate-project:
    name: Validate Godot Project
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Godot templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Import project assets
        working-directory: game
        run: |
          echo "Importing Godot project..."
          godot --headless --editor --quit || echo "Import complete (expected error)"
          
      - name: Validate project.godot
        working-directory: game
        run: |
          if [ -f "project.godot" ]; then
            echo "✓ project.godot exists"
          else
            echo "✗ project.godot not found"
            exit 1
          fi

      - name: Validate resource files
        working-directory: game
        run: |
          echo "Checking for malformed .tres files..."
          find . -name "*.tres" -type f | while read -r file; do
            if grep -q "^\\[" "$file"; then
              echo "✓ $file appears valid"
            else
              echo "⚠ $file may be malformed"
            fi
          done

  unit-tests:
    name: Run Unit Tests (GUT)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Godot templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Import project
        working-directory: game
        run: |
          godot --headless --editor --quit || echo "Import complete"

      - name: Run GUT tests
        working-directory: game
        run: |
          echo "Running GUT unit tests..."
          godot --headless --script addons/gut/gut_cmdln.gd -gconfig=.gutconfig.json -gexit || echo "Tests completed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: game/.gut/*.xml
          if-no-files-found: ignore

  build-test-linux:
    name: Test Linux Export
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: barichello/godot-ci:4.3
    needs: [lint, validate-project]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Godot templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Import project
        working-directory: game
        run: |
          godot --headless --editor --quit || echo "Import complete"

      - name: Test Linux export
        working-directory: game
        run: |
          echo "Testing headless Linux export..."
          mkdir -p export/linux
          godot --headless --export-release "Linux/X11" export/linux/${EXPORT_NAME}.x86_64 || echo "Export test complete"

      - name: Verify export artifacts
        working-directory: game
        run: |
          if [ -f "export/linux/${EXPORT_NAME}.x86_64" ]; then
            echo "✓ Linux binary created successfully"
            ls -lh export/linux/
          else
            echo "⚠ Linux export may have failed"
            exit 1
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [lint, validate-project, unit-tests, build-test-linux]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "CI Pipeline Complete"
          echo "===================="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Validate: ${{ needs.validate-project.result }}"
          echo "Tests: ${{ needs.unit-tests.result }}"
          echo "Build: ${{ needs.build-test-linux.result }}"
          
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.validate-project.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.build-test-linux.result }}" != "success" ]; then
            echo "⚠ Some checks failed or were skipped"
            exit 1
          fi
          
          echo "✓ All checks passed!"
